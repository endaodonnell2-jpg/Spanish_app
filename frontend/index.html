<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lucas11</title>

<style>
:root {
    --neutral: #2ecc71;
    --active: #e74c3c;
    --bg: #f3efe7; /* beige background */
}

* { box-sizing: border-box; }

body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    font-family: -apple-system, system-ui, sans-serif;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

/* Sound bar */
#visualizer-container {
    width: 100%;
    display: flex;
    justify-content: center;
    margin-bottom: 40px;
}

canvas {
    width: 85%;
    height: 70px;
}

/* Hold button centered */
#holdBtn {
    width: 80%;
    max-width: 350px;
    height: 90px;
    border-radius: 20px;
    border: none;
    background: var(--neutral);
    color: white;
    font-size: 1.4rem;
    font-weight: bold;
    touch-action: none;
}

#holdBtn.active {
    background: var(--active);
}
</style>
</head>

<body>

<div id="visualizer-container">
    <canvas id="visualizer"></canvas>
</div>

<button id="holdBtn">HOLD TO SPEAK</button>

<script>
const holdBtn = document.getElementById('holdBtn');
const canvas = document.getElementById('visualizer');
const canvasCtx = canvas.getContext('2d');

let audioCtx;
let analyser;
let dataArray;
let mediaRecorder;
let audioChunks = [];

/* ---------- AUDIO INIT ---------- */
async function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === "suspended") {
        await audioCtx.resume();
    }
}

/* ---------- VISUALIZER ---------- */
function setupVisualizer(sourceNode, color) {
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;

    sourceNode.connect(analyser);

    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);

    function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);

        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        canvasCtx.fillStyle = color;

        let x = 0;
        const barWidth = 3;

        for (let i = 0; i < bufferLength; i++) {
            const barHeight = dataArray[i] / 2;
            canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 2;
        }
    }

    draw();
}

/* ---------- HOLD TO SPEAK ---------- */
holdBtn.addEventListener("pointerdown", async (e) => {
    e.preventDefault();
    await initAudio();

    holdBtn.classList.add("active");
    audioChunks = [];

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const micSource = audioCtx.createMediaStreamSource(stream);

    setupVisualizer(micSource, "#e74c3c"); // red user bars

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
    mediaRecorder.onstop = sendAudio;
    mediaRecorder.start();
});

window.addEventListener("pointerup", () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        holdBtn.classList.remove("active");
    }
});

/* ---------- SEND AUDIO ---------- */
async function sendAudio() {
    const blob = new Blob(audioChunks, { type: "audio/webm" });
    if (blob.size < 1000) return;

    const formData = new FormData();
    formData.append("file", blob, "user.webm");

    const response = await fetch("/process_audio", {
        method: "POST",
        body: formData
    });

    const data = await response.json();

    if (data.tts_url) {
        playAI(data.tts_url);
    }
}

/* ---------- AI PLAYBACK ---------- */
function playAI(url) {
    const audio = new Audio(url);
    audio.crossOrigin = "anonymous";

    const aiSource = audioCtx.createMediaElementSource(audio);
    setupVisualizer(aiSource, "#2ecc71"); // green AI bars

    aiSource.connect(audioCtx.destination);

    audio.play();
}
</script>

</body>
</html>

