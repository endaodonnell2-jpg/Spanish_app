<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lucas11</title>

<style>
:root {
    --bg: #f3efe7;
    --green1: #3df58a;
    --green2: #18b45c;
    --red1: #ff5a5a;
    --red2: #b30000;
    --grey: #bbbbbb;
}

* {
    box-sizing: border-box;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    background: var(--bg);
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    font-family: -apple-system, system-ui, sans-serif;
}

#visualizer {
    width: 90%;
    height: 100px;
    margin-bottom: 60px;
}

#micBtn {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: radial-gradient(circle at 30% 30%, var(--green1), var(--green2));
    box-shadow:
        0 15px 30px rgba(0,0,0,0.25),
        inset 0 6px 10px rgba(255,255,255,0.4),
        inset 0 -8px 15px rgba(0,0,0,0.3);
    transition: transform 0.18s ease, box-shadow 0.18s ease;
    animation: idleGlow 3s ease-in-out infinite alternate;
}

@keyframes idleGlow {
    0% { box-shadow: 0 15px 30px rgba(0,0,0,0.25); }
    100% { box-shadow: 0 18px 36px rgba(0,0,0,0.28); }
}

#micBtn.active {
    background: radial-gradient(circle at 30% 30%, var(--red1), var(--red2));
    animation: none;
}

#micBtn.pressed {
    transform: scale(0.92);
}

#micBtn.thinking {
    animation: thinkingPulse 1.2s ease-in-out infinite;
}

@keyframes thinkingPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
}

#micBtn svg {
    width: 60%;
    height: 60%;
    fill: white;
    pointer-events: none;
}
</style>
</head>

<body>

<canvas id="visualizer"></canvas>

<div id="micBtn">
    <svg viewBox="0 0 24 24">
        <path d="M12 14a3 3 0 003-3V5a3 3 0 10-6 0v6a3 3 0 003 3zm5-3a1 1 0 10-2 0 3 3 0 01-6 0 1 1 0 10-2 0 5 5 0 004 4.9V19H9a1 1 0 000 2h6a1 1 0 000-2h-2v-3.1A5 5 0 0017 11z"/>
    </svg>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

const canvas = document.getElementById("visualizer");
const ctx = canvas.getContext("2d");
const micBtn = document.getElementById("micBtn");

/* ===== AUDIO CORE (PERMANENT) ===== */

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const analyser = audioCtx.createAnalyser();
analyser.fftSize = 2048;
const dataArray = new Uint8Array(analyser.fftSize);

/* Silent oscillator keeps Safari alive */
const oscillator = audioCtx.createOscillator();
const silentGain = audioCtx.createGain();
silentGain.gain.value = 0.0001;
oscillator.connect(silentGain);
silentGain.connect(audioCtx.destination);
oscillator.start();

/* Resume audio on any touch */
async function forceResume(){
    if(audioCtx.state !== "running"){
        await audioCtx.resume();
    }
}
window.addEventListener("touchstart", forceResume, {passive:true});
window.addEventListener("pointerdown", forceResume, {passive:true});

/* ===== STATE ===== */

let state="idle";
let mediaRecorder;
let audioChunks=[];
let currentAudio=null;
let currentController=null;
let latestRequestId=0;
let pressStartTime=0;

/* ===== CANVAS LOOP (ONE LOOP ONLY) ===== */

function resize(){
    canvas.width=canvas.offsetWidth;
    canvas.height=canvas.offsetHeight;
}
resize();
window.addEventListener("resize",resize);

function draw(){
    requestAnimationFrame(draw);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(state==="idle"){
        ctx.strokeStyle="#bbbbbb";
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(0,canvas.height/2);
        ctx.lineTo(canvas.width,canvas.height/2);
        ctx.stroke();
        return;
    }

    analyser.getByteTimeDomainData(dataArray);

    ctx.lineWidth=3;
    ctx.strokeStyle= state==="user" ? "#e74c3c" : "#2ecc71";
    ctx.beginPath();

    const sliceWidth=canvas.width/dataArray.length;
    let x=0;

    for(let i=0;i<dataArray.length;i++){
        const v=dataArray[i]/128.0;
        const y=v*canvas.height/2;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
        x+=sliceWidth;
    }

    ctx.stroke();
}
draw();

/* ===== RECORD ===== */

micBtn.addEventListener("pointerdown", async(e)=>{
    e.stopPropagation();
    await forceResume();

    stopAudio();
    cancelRequest();

    state="user";
    micBtn.classList.add("active","pressed");
    pressStartTime=performance.now();
    audioChunks=[];

    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const source=audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);

    mediaRecorder=new MediaRecorder(stream);
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=sendAudio;
    mediaRecorder.start();
});

function stopRecording(){
    const duration=performance.now()-pressStartTime;

    if(mediaRecorder && mediaRecorder.state==="recording"){
        mediaRecorder.stop();
    }

    micBtn.classList.remove("pressed");

    if(duration<200){
        state="idle";
        micBtn.classList.remove("active");
        return;
    }

    micBtn.classList.remove("active");
    state="thinking";
    micBtn.classList.add("thinking");
}

window.addEventListener("pointerup",stopRecording);
window.addEventListener("pointercancel",stopRecording);

/* ===== SEND ===== */

async function sendAudio(){
    const blob=new Blob(audioChunks,{type:"audio/webm"});
    if(blob.size<1000){
        state="idle";
        micBtn.classList.remove("thinking");
        return;
    }

    const formData=new FormData();
    formData.append("file",blob);

    currentController=new AbortController();
    const requestId=++latestRequestId;

    try{
        const res=await fetch("/process_audio",{
            method:"POST",
            body:formData,
            signal:currentController.signal
        });

        const data=await res.json();

        if(requestId===latestRequestId && data.tts_url){
            playAI(data.tts_url);
        }

    }catch(err){}
}

/* ===== AI ===== */

function playAI(url){
    stopAudio();
    state="ai";
    micBtn.classList.remove("thinking");

    const audio=new Audio(url+"?t="+Date.now());
    currentAudio=audio;

    const source=audioCtx.createMediaElementSource(audio);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);

    audio.onended=()=>state="idle";
    audio.play().catch(()=>{});
}

function stopAudio(){
    if(currentAudio){
        currentAudio.pause();
        currentAudio.src="";
        currentAudio.load();
        currentAudio=null;
    }
}

function cancelRequest(){
    if(currentController){
        currentController.abort();
        currentController=null;
    }
}

});
</script>

</body>
</html>
